---
# demo-tests/tasks/main.yml
# Configures the demo test environment

- name: Install test dependency packages
  apt:
    name: "{{ item }}"
    update_cache: yes
    cache_valid_time: 3600
    state: present
  with_items:
    - git
    - valgrind
    - python-pip

- name: Install yaml from PyPi
  become: yes
  pip:
    name: pyyaml

- name: Clone syndicate-tests repo
  git:
    repo: https://github.com/syndicate-storage/syndicate-tests
    dest: /opt/syndicate-tests
    version: master

- name: Fix ownership of syndicate-tests
  file:
    path: /opt/syndicate-tests
    owner: syndicate
    group: syndicate
    recurse: yes
    state: directory

- name: Copy legacy test files
  copy:
    src: legacy-tests
    dest: /opt
    owner: syndicate
    group: syndicate
    directory_mode: "u=rwx,g=rx,o=rx"

- name: Fix script permissions
  command: 'find /opt \( -name "*.py" -o -name "*.sh" \) -exec chmod +x {} \;'

- name: Create test results directories
  file:
    name: "{{ item }}"
    state: directory
    owner: syndicate
    group: syndicate
  with_items:
    - /opt/results
    - /opt/output
    - /opt/legacy-tests/results
    - /opt/legacy-tests/output

- name: Create demo-tests softlinks
  file:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: syndicate
    group: syndicate
    state: link
  with_items:
    - src: /opt/syndicate-tests
      dest: /home/syndicate/syndicate-tests
    - src: /usr/src/syndicate/ms
      dest: /opt/ms

- name: Get syndicate-ms certs
  copy:
    src: "/tmp/{{ item }}"
    dest: "/opt/ms_certs/"
    owner: syndicate
    group: syndicate
  with_items:
    - admin.pub
    - admin.pem
    - syndicate.pub
    - syndicate.pem
